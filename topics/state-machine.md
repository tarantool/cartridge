[TOC]

# Unconfigured

Состояние инстанса при отсутствии файлов конфигурации и снапшотов. Стандартное состояние при запуске не настроенного кластера. `boot_instance()` будет вызвано позже с помощью `net.box`, инстанс перейдет в состояние  `BootstrappingBox`.

# ConfigFound

Состояние инстанса, когда все файлы конфигурации (`*.yml` и снапшоты) существуют и найдены, но еще не загружены. При неудачной загрузке конфигурации инстанс переходит в состояние `InitError`, иначе в `ConfigLoaded`.

# ConfigLoaded

Конфигурация найдена, загружена и валидированна. Далее предстоит настройка инстанса. В случае наличия снапшотов инстанс переходит в состояние `RecoveringSnapshot` и начнет восстановление. Если их нет, то инстанс переходит в состояние `BootstrappingBox`.

# InitError

Ошибка инициализации инстанса -- состояние, в которое попадает инстанс из-за:

- Ошибки при подключении с помощью `cartridge.remote-control`  к бинарному порту
- Отсутствии `config.yml` в рабочей директории (`tmp/`) при наличии файлов снапшотов
- Ошибки при загрузке конфигурации кластера с диска
- Невалидной конфигурации
- Отсутствия сервера в конфигурации кластера

# BootstrappingBox

Настройка параметров для `box.cfg` в случае отсутствия снапшотов (`ConfigLoaded->` )  или конфигурационных файлов (`Unconfigured->`) и ее выполнение. Настройка пользователей. Отключение `remote-control`. В случае неудачного подключения к порту для использования протокола iproto инстанс переходит в состояние  `BootError`. В случае отсутствия репликасета к конфигурации кластера инстанс переходит в состояние `BootError`. Если все хорошо, то инстанс переходит в `ConnectingFullmesh`.

# RecoveringSnapshot

В случае наличия снапшотов параметры для `box.cfg` настраиваются соответственно, вызов `box.cfg` выполняет процесс восстановления из снапшотов. Далее следует настройка пользователей и отключение `remote-control`. В случае неудачного подключения к порту для использования протокола iproto инстанс переходит в состояние  `BootError`. В случае отсутствия репликасета к конфигурации кластера инстанс переходит в состояние `BootError`. Если все хорошо, то инстанс переходит в `ConnectingFullmesh`.

# BootError

Состояние инстанса, вызванное одной из следующих ошибок:

- Неудачное подключение к порту для использования iproto
- Отсутствие сервера в конфигурации кластера
- Отсутствие репликасета в конфигурации кластера
- Неудачная настройка репликации

# ConnectingFullmesh

Состояние инстанса, в котором происходит настройка серверов, репликасетов и реализуется кластерная топология, описанная в конфигурации.

# BoxConfigured

Состояние следующее вслед за успешной настройкой репликасетов и топологии кластера. Далее следует настройка ролей.

# ConfiguringRoles

Состояние настройки ролей. В данное состояние инстанс может попасть при первоначальной настройке, триггере failover (`failover.lua`) или при изменении конфигурации кластера (`twophase.lua`).

# RolesConfigured

Успешная настройка ролей.

# OperationError

Ошибка при настройке ролей.



