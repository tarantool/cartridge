variables:
  ROCK_NAME: cartridge

stages:
  - build
  - publish

build:
  stage: build
  tags:
    - docker
  image: centos:7
  variables:
    BUNDLE_VERSION: "1.10.4-8-g3f2b35b"
  cache:
    key: $BUNDLE_VERSION
    paths:
      - tarantool-enterprise/
  before_script:
    - echo "Using tarantool-enterprise-bundle ${BUNDLE_VERSION}"
    - |
      if [ ! -e tarantool-enterprise ]
      then
        curl -O -L https://tarantool:${DOWNLOAD_TOKEN}@download.tarantool.io/enterprise/tarantool-enterprise-bundle-${BUNDLE_VERSION}.tar.gz
        tar -xzf tarantool-enterprise-bundle-${BUNDLE_VERSION}.tar.gz
        rm -rf tarantool-enterprise-bundle-${BUNDLE_VERSION}.tar.gz
      fi
    - export PATH=$PWD/tarantool-enterprise:$PATH
    - yum -y install https://centos7.iuscommunity.org/ius-release.rpm
    - yum -y install gtk3 xorg-x11-server-Xvfb libXScrnSaver GConf2 alsa-lib # cypress deps
    - curl -sL https://rpm.nodesource.com/setup_8.x | bash -
    - yum -y install git gcc make cmake unzip python python-pip nodejs
    - tarantoolctl rocks install ldoc --server=http://rocks.moonscript.org
    - tarantoolctl rocks install luacheck
    - tarantoolctl rocks install luacov
    - tarantoolctl rocks install luacov-console 1.1.0
    - pip install -r test/integration/requirements.txt
    - tarantoolctl rocks install luatest 0.2.2
    - npm install graphql-cli@3.0.14
    - export PATH=node_modules/.bin:$PATH
  script:
    - tarantoolctl rocks make
    - pytest -v
    - ./run-test.sh
    - ./fetch-schema.sh
    - ./check-flow-graphql.sh
    - ./release.sh

  artifacts:
    name: "$CI_COMMIT_REF_NAME"
    paths:
      - doc/
      - release/
      - release-doc/
      - luacov.report.out

publish-scm-1:
  stage: publish
  tags:
    - docker
  image: centos:7
  only:
    - master
  script:
    - curl --fail -X PUT -F "rockspec=@${ROCK_NAME}-scm-1.rockspec"
      https://${ROCKS_USERNAME}:${ROCKS_PASSWORD}@rocks.tarantool.org


publish-release:
  stage: publish
  tags:
    - docker
  image: centos:7
  only:
    - tags
  script:
    - cd release/
    - curl --fail -X PUT -F "rockspec=@${ROCK_NAME}-${CI_COMMIT_TAG}-1.rockspec"
      https://${ROCKS_USERNAME}:${ROCKS_PASSWORD}@rocks.tarantool.org
    - curl --fail -X PUT -F "rockspec=@${ROCK_NAME}-${CI_COMMIT_TAG}-1.all.rock"
      https://${ROCKS_USERNAME}:${ROCKS_PASSWORD}@rocks.tarantool.org
