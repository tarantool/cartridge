name: Frontend Test

on:
  push:
  workflow_dispatch:

env:
  CMAKE_DUMMY_WEBUI: false

jobs:
  webui-test:
    strategy:
      fail-fast: false
      matrix:
        script:
          - frontend
          - cypress-1
          - cypress-2
    runs-on: ubuntu-18.04
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v1

      - uses: tarantool/setup-tarantool@v1
        with:
          tarantool-version: '2.6'

      ##################################################################
      # Setup rocks
      - name: Cache rocks
        uses: actions/cache@v2
        id: cache-rocks
        with:
          path: .rocks/
          key: rocks-${{ hashFiles('cartridge-scm-1.rockspec') }}
          restore-keys: rocks
      -
        run: tarantoolctl rocks install luatest 0.5.2
        if: steps.cache-rocks.outputs.cache-hit != 'true'

      ##################################################################
      # Cachce node_modules
      - name: Cache node_modules
        uses: actions/cache@v2
        with:
          path: webui/node_modules/
          key: node-modules-${{ hashFiles('webui/package-lock.json') }}

      ##################################################################
      # Cachce webui bundle
      - name: Cache webui bundle
        uses: actions/cache@v2
        with:
          path: |
            webui/build/bundle.lua
            webui/build/bundle.md5
          key: webui-bundle

      ##################################################################
      # Cache cypress
      - run: echo node_modules/.bin/ >> $GITHUB_PATH
      - name: Cache cypress
        if: startsWith(matrix.script, 'cypress')
        id: cache-cypress
        uses: actions/cache@v2
        with:
          path: |
            ./node_modules
            ~/.cache/Cypress
          key: cypress-cache-6.2.0-${{ runner.os }}-1
      -
        run: |
          npm install cypress@6.2.0
          npx cypress verify
        if: >
          startsWith(matrix.script, 'cypress') &&
          steps.cache-cypress.outputs.cache-hit != 'true'

      ##################################################################

      - run: tarantoolctl rocks make

      - if: matrix.script == 'frontend'
        run: ./frontend-test.sh

      - if: startsWith(matrix.script, 'cypress')
        run: ./cypress-test.sh run
          --parallel
          --record
          --key ${{ secrets.CYPRESS_RECORD_KEY }}

      ##################################################################
      # Cleanup cached paths
      - run: tarantoolctl rocks remove cartridge
