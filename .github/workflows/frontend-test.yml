name: Frontend Test

on:
  push:
  workflow_dispatch:

env:
  CMAKE_DUMMY_WEBUI: false

jobs:
  webui-test:
    strategy:
      fail-fast: false
      matrix:
        runs-on: [ubuntu-18.04]
    runs-on: ${{ matrix.runs-on }}
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v1

      - uses: tarantool/setup-tarantool@v1
        with:
          tarantool-version: '2.6'

      - name: Cache rocks
        uses: actions/cache@v2
        id: cache-webui-rocks
        with:
          path: .rocks/
          key: cache-webui-rocks-${{ matrix.runs-on }}
      -
        run: tarantoolctl rocks install luatest 0.5.2
        if: steps.cache-webui-rocks.outputs.cache-hit != 'true'

      - name: Cache node_modules
        uses: actions/cache@v2
        with:
          path: webui/node_modules/
          key: >
            cache-node-modules-${{ hashFiles(
            'webui/package-lock.json'
            ) }}

      - name: Cache webui bundle
        uses: actions/cache@v2
        with:
          path: |
            webui/build/bundle.lua
            webui/build/bundle.md5
          key: >
            cache-webui-bundle-${{ hashFiles(
            'webui/src/*',
            'webui/config/*.prod.js',
            'webui/flow-typed/*',
            'webui/public/*',
            'webui/.env',
            'webui/.env.production',
            'webui/.eslintrc',
            'webui/.flowconfig',
            'webui/codegen.yml',
            'webui/scripts/build.js',
            'webui/package-lock.json'
            ) }}

      - run: tarantoolctl rocks make

      - name: Cache cypress
        id: cache-cypress
        uses: actions/cache@v2
        with:
          path: ~/.cache/Cypress
          key: cypress-cache-${{ runner.os }}

      - run: npm install cypress@6.2.0
      - run: npx cypress cache list

      - run: ./cypress-test.sh run --record --key ${{ secrets.CYPRESS_RECORD_KEY }}
      - run: ./frontend-test.sh

      # Cleanup cached paths
      - run: tarantoolctl rocks remove cartridge
