name: Frontend Test

on:
  push:
  workflow_dispatch:

env:
  CMAKE_DUMMY_WEBUI: false

jobs:
  webui-test:
    runs-on: ubuntu-18.04
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v1

      - uses: rosik/setup-tarantool@v1
        with:
          tarantool-version: '1.10'

      - name: Cache build dir
        uses: actions/cache@v2
        with:
          path: |
            .rocks/
            build.luarocks/
            webui/build/
            webui/node_modules/
          key: frontend-build

      - run: tarantoolctl rocks install luatest 0.5.2
      - run: tarantoolctl rocks make

      - name: Cache cypress
        id: cache-cypress
        uses: actions/cache@v2
        with:
          path: ~/.cache/Cypress
          key: cypress-cache-${{ runner.os }}

      - run: npm install cypress@4.12.1
      - run: npx cypress cache list

      - run: ./cypress-test.sh
      - run: ./frontend-test.sh

      # Cleanup cached paths
      - run: tarantoolctl rocks remove cartridge
